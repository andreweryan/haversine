pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS = credentials('GITHUB_CREDENTIALS')
        REPO = "andreweryan/haversine"
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    git branch: 'main', 
                        credentialsId: 'GITHUB_CREDENTIALS', 
                        url: "https://${env.GITHUB_CREDENTIALS_USR}:${env.GITHUB_CREDENTIALS_PSW}@github.com/${REPO}.git"
                }
            }
        }

        stage('Determine Release Version') {
            steps {
                script {
                    def latestTag = sh(script: "git describe --tags --abbrev=0 || echo v0.0.0", returnStdout: true).trim()
                    def versionParts = latestTag.replace("v", "").tokenize('.')
                    def newVersion = "v${versionParts[0]}.${versionParts[1]}.${versionParts[2].toInteger() + 1}"
                    env.VERSION = newVersion
                    echo "New release version: ${env.VERSION}"
                }
            }
        }

        stage('Create Git Tag') {
            steps {
                sh '''
                    git config --global user.email "jenkins@localhost"
                    git config --global user.name "Jenkins"
                    git tag -a ${VERSION} -m "Release ${VERSION}"
                    git push origin ${VERSION}
                '''
            }
        }
    }

    post {
        success {
            echo "Release ${VERSION} created successfully!"
        }
        failure {
            echo "Release failed!"
        }
    }
}
